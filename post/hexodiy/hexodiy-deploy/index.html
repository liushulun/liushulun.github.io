<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)">
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png">
  <link rel="mask-icon" href="/assets/images/favicon-logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/orange/pace-theme-flash.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"luisliu.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12,"reverse":true},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":true,"motion":{"enable":false,"async":true,"transition":{"menu_item":null,"post_block":"fadeInDown","post_header":null,"post_body":null,"coll_header":null,"sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="（1）GitHub 多 Page 仓库部署（账号 Page 与项目 Page）；（2）云服务器部署（创建、配置、部署、SSL 证书）。">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo-自定义部署">
<meta property="og:url" content="https://luisliu.cn/post/hexodiy/hexodiy-deploy/index.html">
<meta property="og:site_name" content="LuisLiu">
<meta property="og:description" content="（1）GitHub 多 Page 仓库部署（账号 Page 与项目 Page）；（2）云服务器部署（创建、配置、部署、SSL 证书）。">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2018-07-21T22:30:25.000Z">
<meta property="article:author" content="LuisLiu">
<meta property="article:tag" content="Hexo">
<meta property="article:tag" content="自定义">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://luisliu.cn/post/hexodiy/hexodiy-deploy/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://luisliu.cn/post/hexodiy/hexodiy-deploy/","path":"post/hexodiy/hexodiy-deploy/","title":"Hexo-自定义部署"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Hexo-自定义部署 | LuisLiu</title>
  














<script>
    <!--动态浏览器标签-->
    const ORIGINAL_TITLE = document.title;
    const WELCOME_TITLE = "Welcome Back!";
    const ANIM_TAB_TITLE_HALF_SPACE_CHAR = "\u2002";
    const ANIM_TAB_TITLE_FULL_SPACE_CHAR = "\u3000";
    const ANIM_TAB_TITLE_SHOW_INTERVAL = 50;
    const ANIM_TAB_TITLE_SHOW_STAY = 500;
    const timerSet = new Set();
    document.addEventListener('visibilitychange', function () {
        if (document.hidden) {
            clearTimerSet();

            // $('[rel="icon"]').attr('href', "/images/favicon-32x32-next.png");
            var faviconLink = document.querySelectorAll('[rel="icon"]');
            if (faviconLink != null) {
                faviconLink.href = "/images/favicon-32x32-next.png";
            }
            // 失去焦点时不切换标题
            // document.title = "Waiting...";
            document.title = ORIGINAL_TITLE;
        } else {
            document.title = "";
            showTabTitleAnim(WELCOME_TITLE);
        }
    });

    function showTabTitleAnim(titleText) {
        if (titleText == ORIGINAL_TITLE) {
            clearTimerSet();
            document.title = ORIGINAL_TITLE;
            return;
        }
        const showingLength = (document.title == null) ? 0 : document.title.length;
        if (showingLength >= titleText.length) {
            var timer = setTimeout(function() {
                clearTimerSet();
                document.title = ORIGINAL_TITLE;
            }, ANIM_TAB_TITLE_SHOW_STAY);
            timerSet.add(timer);
        } else {
            const nextChar = titleText[showingLength];
            if (nextChar.trim().length <= 0) {
                // document.title 无法以空格结尾（会被自动删除），导致死循环一直追加空格，必须用专门的空白字符替代。
                document.title += ANIM_TAB_TITLE_HALF_SPACE_CHAR;
                showTabTitleAnim(titleText);
                return;
            }
            document.title += nextChar;
            var timer = setTimeout(function() {
                timerSet.delete(timer);
                showTabTitleAnim(titleText);
            }, ANIM_TAB_TITLE_SHOW_INTERVAL);
            timerSet.add(timer);
        }
    }

    function clearTimerSet() {
        timerSet.forEach(function(value, key, set) {
            clearTimeout(value);
        });
        timerSet.clear();
    }
</script>




<script>
    Pace.options.eventLag = false;
    document.addEventListener("readystatechange", () => {
        if (document.readyState === "interactive") {
            // Do fancy stuff like not pace.js related stuff (animations etc).
        } else if (document.readyState === "complete") {
            // Force all animation to finish.
            Pace.stop();
            // Hide pace elements.
            //document
            //    .querySelector("#pace-content")
            //    .classList.replace("opacity-0", "opacity-100");
        }
    });
</script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">LuisLiu</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">2025/09/10 - 02:24:18</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-th-large fa-fw"></i>About</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">82</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">14</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">153</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>


</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Catalogue
        </li>
        <li class="sidebar-nav-overview">
          Site
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Hexo-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%83%A8%E7%BD%B2"><span class="nav-text">Hexo-自定义部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%A4%9APage%E4%BB%93%E5%BA%93%E9%83%A8%E7%BD%B2"><span class="nav-text">1. 多Page仓库部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%BC%80%E5%90%AF%E9%A1%B9%E7%9B%AEPage"><span class="nav-text">1.1 开启项目Page</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%9F%9F%E5%90%8D"><span class="nav-text">1.2 自定义域名</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%83%A8%E7%BD%B2"><span class="nav-text">2. 云服务器部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E6%90%AD%E5%BB%BA%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-text">2.1 搭建云服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-1-%E5%87%86%E5%A4%87%E9%83%A8%E7%BD%B2%E7%8E%AF%E5%A2%83"><span class="nav-text">2.1.1 准备部署环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-2-%E9%85%8D%E7%BD%AEUbuntu%E9%BB%98%E8%AE%A4%E8%B4%A6%E5%8F%B7"><span class="nav-text">2.1.2 配置Ubuntu默认账号</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-3-%E7%99%BB%E5%BD%95%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-text">2.1.3 登录服务器</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E9%85%8D%E7%BD%AE%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-text">2.2 配置云服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-%E5%BC%80%E5%90%AFRoot%E7%94%A8%E6%88%B7"><span class="nav-text">2.2.1 开启Root用户</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-2-%E5%AE%89%E8%A3%85%E7%8E%AF%E5%A2%83"><span class="nav-text">2.2.2 安装环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-3-%E9%85%8D%E7%BD%AE%E7%BD%91%E7%AB%99%E7%9B%AE%E5%BD%95"><span class="nav-text">2.2.3 配置网站目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-4-%E9%AA%8C%E8%AF%81%E7%BD%91%E7%AB%99%E8%AE%BF%E9%97%AE%E6%80%A7"><span class="nav-text">2.2.4 验证网站访问性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-5-%E5%88%9B%E5%BB%BAGit-Hook"><span class="nav-text">2.2.5 创建Git-Hook</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E6%9C%AC%E5%9C%B0Push%E8%87%B3%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-text">2.3 本地Push至云服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-GitHub-Page%E5%BC%80%E5%90%AFHTTPS"><span class="nav-text">2.4 GitHub-Page开启HTTPS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%90%AFHTTPS"><span class="nav-text">2.5 云服务器开启HTTPS</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-1-%E4%BB%8E%E5%9F%9F%E5%90%8D%E6%8F%90%E4%BE%9B%E5%95%86%E8%8E%B7%E5%8F%96SSL%E8%AF%81%E4%B9%A6"><span class="nav-text">2.5.1 从域名提供商获取SSL证书</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-2-LetsEncrypt%E8%AF%81%E4%B9%A6-DNS%E6%A0%A1%E9%AA%8C"><span class="nav-text">2.5.2 LetsEncrypt证书+DNS校验</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-3-LetsEncrypt%E8%AF%81%E4%B9%A6-HTTP%E6%A0%A1%E9%AA%8C"><span class="nav-text">2.5.3 LetsEncrypt证书+HTTP校验</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-4-%E5%B0%86SSL%E5%85%AC%E7%A7%81%E9%92%A5%E9%85%8D%E7%BD%AE%E5%88%B0Nginx"><span class="nav-text">2.5.4 将SSL公私钥配置到Nginx</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-%E9%AA%8C%E8%AF%81%E7%BD%91%E7%AB%99%E8%AE%BF%E9%97%AE"><span class="nav-text">2.6 验证网站访问</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-7-%E5%B8%B8%E8%A7%81%E5%BC%82%E5%B8%B8"><span class="nav-text">2.7 常见异常</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="nav-text">参考文献</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="LuisLiu"
      src="/assets/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">LuisLiu</p>
  <div class="site-description" itemprop="description">Keep Learning</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">82</span>
          <span class="site-state-item-name">Posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">Categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">153</span>
        <span class="site-state-item-name">Tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="/" title="Home → &#x2F;" rel="noopener me"><i class="fa fa-home fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://github.com/liushulun" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;liushulun" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="http://sighttp.qq.com/authd?IDKEY=50d1f9647e1441567ff941b646b66c8053449b2557ca041d" title="Chats → http:&#x2F;&#x2F;sighttp.qq.com&#x2F;authd?IDKEY&#x3D;50d1f9647e1441567ff941b646b66c8053449b2557ca041d" rel="noopener me" target="_blank"><i class="fab fa-qq fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:luisio@foxmail.com" title="E-Mail → mailto:luisio@foxmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
  </div>



<script>
    const ANIM_SIDEBAR_TEXT_SHOW_INTERVAL = 30;
    const ANIM_SIDEBAR_TEXT_SHOW_STAY = 5000;
    const ANIM_SIDEBAR_TEXT_HIDE_INTERVAL = 15;
    const ANIM_SIDEBAR_TEXT_HIDE_STAY = 1000;
    const ANIM_SIDEBAR_CURSOR_INTERVAL = 500;

    const ANIM_SIDEBAR_TEXT_SET = [`Welcome!`,
                       `Feel free.`,
                       `Keep learning!`,
                       `Good luck!`,
                       `Nice to meet you.`,
                       `Does anything interest you?`,
                       `Let's exchange the friend-link!`,
                       `Comment will be available soon.`,
                       `Can't wait to chat with you!`,
                       ];
    var currentAnimText = ANIM_SIDEBAR_TEXT_SET[0];

    function genRandomSidebarText(minVal, maxVal) {
        switch (arguments.length) {
            case 1: {
                return parseInt(Math.random() * minVal, 10); // parseInt 约等于 floor 都是向下取整，第二个参数表示 10 进制
            }
            case 2: {
                return parseInt((Math.random() * (maxVal - minVal)) + minVal, 10);
            }
            default: {
                return 0;
            }
        }
    }

    function startSidebarTextAnim(textNode) {
        if (textNode == null) {
            return;
        }
        showSidebarTextAnim(textNode);
    }

    function startSidebarTextCursorAnim(cursorNode) {
        if (cursorNode == null) {
            return;
        }
        setTimeout(function() {
            if (cursorNode.style.color == 'transparent') {
                cursorNode.style.color = '#999999';
            } else {
                cursorNode.style.color   = 'transparent';
            }
            startSidebarTextCursorAnim(cursorNode);
        }, ANIM_SIDEBAR_CURSOR_INTERVAL);
    }

    function showSidebarTextAnim(textNode) {
        if (textNode == null) {
            return;
        }
        const showingLength = (textNode.innerHTML == null) ? 0 : textNode.innerHTML.length;
        if (showingLength < currentAnimText.length) {
            const nextChar = currentAnimText[showingLength];
            textNode.innerHTML += nextChar;
            if (nextChar.trim().length <= 0) {
                showSidebarTextAnim(textNode);
                return;
            }
            setTimeout(function() {
                showSidebarTextAnim(textNode);
            }, ANIM_SIDEBAR_TEXT_SHOW_INTERVAL);
        } else {
            setTimeout(function() {
                hideSidebarTextAnim(textNode);
            }, ANIM_SIDEBAR_TEXT_SHOW_STAY);
        }
    }

    function hideSidebarTextAnim(textNode) {
        if (textNode == null) {
            return;
        }
        const showingLength = (textNode.innerHTML == null) ? 0 : textNode.innerHTML.length;
        if (showingLength > 0) {
            textNode.innerHTML = textNode.innerHTML.slice(0, -1);
            setTimeout(function() {
                hideSidebarTextAnim(textNode);
            }, ANIM_SIDEBAR_TEXT_HIDE_INTERVAL);
        } else {
            // 所有文字都隐藏后，重新随机选择一个文案。
            // 随机选择时，如果新随机到的文案与上一次的相同，则重新随机一次，最多重试 3 次。
            for (var i = 0; i < 3; i++) {
                let randomTextIndex = genRandomSidebarText(ANIM_SIDEBAR_TEXT_SET.length);
                let randomText = ANIM_SIDEBAR_TEXT_SET[randomTextIndex];
                if (randomText.trim().length <= 0) {
                    continue;
                }
                if (currentAnimText !== randomText) {
                    currentAnimText = randomText;
                    break;
                }
            }
            setTimeout(function() {
                showSidebarTextAnim(textNode);
            }, ANIM_SIDEBAR_TEXT_HIDE_STAY);
        }
    }


    // 创建 Observer，用于监听指定节点及其子节点的所有变化。
    const siteAuthorObserver = new MutationObserver(function() {
        // 找到所有符合 SiteAuthor（包含头像、名称、描述）特征的节点（<div class="site-author">）：
        const allFoundParents = document.getElementsByClassName('site-author');
        if (allFoundParents.length <= 0) {
            // Do nothing, keep observing.
            return;
        }

        // 确保找到的 SiteAuthor 是 Sidebar 内的元素：
        var parentNode = null;
        for (var i = 0; i < allFoundParents.length; i++) {
            const eachNode = allFoundParents[i];
            if (eachNode.parentNode != null && eachNode.parentNode.classList.contains('site-overview-wrap') && eachNode.parentNode.classList.contains('sidebar-panel')) {
                parentNode = eachNode;
                break;
            }
        }
        if (parentNode == null) {
            return;
        }

        siteAuthorObserver.disconnect();

        // 遍历 SiteAuthor 的子元素，找到 SiteDescription 元素：
        var anchorNode = null;
        for (var i = 0; i < parentNode.children.length; i++) {
            const eachNode = parentNode.children[i];
            if (eachNode.classList.contains('site-description')) {
                anchorNode = eachNode;
                break;
            }
        }
        if (anchorNode == null) {
            return;
        }

        // 清空 SiteDescription 元素：
        while (anchorNode.children.length > 0) {
            anchorNode.children[0].remove();
        }
        anchorNode.innerHTML = null;
        anchorNode.innerText = null;

        //
        const containerDiv = document.createElement('div');
        containerDiv.setAttribute('id', "containerDiv");
        containerDiv.setAttribute('style', "padding:5px 0px; margin:0px; text-align:center; display:flex; justify-content:center; line-height:1; font-size:1.0em!important; min-height:1.0em!important;");
        //parent.insertBefore(containerDiv, parent.firstChild);
        anchorNode.insertBefore(containerDiv, anchorNode.firstChild);
        //
        const textDiv = document.createElement('div');
        textDiv.setAttribute('style', "padding:0px; margin:0px;");
        startSidebarTextAnim(textDiv);
        containerDiv.appendChild(textDiv);
        //
        const cursorDiv = document.createElement('div');
        cursorDiv.setAttribute('style', "padding:0px; margin:0px;");
        cursorDiv.innerHTML = '|';
        startSidebarTextCursorAnim(cursorDiv);
        containerDiv.appendChild(cursorDiv);
    });
    siteAuthorObserver.observe(document, {
        childList: true,
        subtree: true
    });

    document.addEventListener('DOMContentLoaded', function() {
        // 所有 DOM(Document Object Model) 加载完成后，不论 siteAuthorObserver 是否监听到，都需要取消监听。
        siteAuthorObserver.disconnect();
    });
</script>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://luisliu.cn/post/hexodiy/hexodiy-deploy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/images/avatar.jpg">
      <meta itemprop="name" content="LuisLiu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LuisLiu">
      <meta itemprop="description" content="Keep Learning">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Hexo-自定义部署 | LuisLiu">
      <meta itemprop="description" content="（1）GitHub 多 Page 仓库部署（账号 Page 与项目 Page）；（2）云服务器部署（创建、配置、部署、SSL 证书）。">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Hexo-自定义部署
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted:</span>

      <time title="Created:: 2018-07-22 06:30:25" itemprop="dateCreated datePublished" datetime="2018-07-22T06:30:25+08:00">2018-07-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">Categories:</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/HexoDIY/" itemprop="url" rel="index"><span itemprop="name">HexoDIY</span></a>
        </span>
    </span>

  


  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="far fa-tags"></i>
    </span>
    <span class="post-meta-item-text">Tags:</span>
      <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
        <a href="/tags/Hexo/" itemprop="url" rel="tag"><span itemprop="name">Hexo</span></a>
      </span>
        , 
      <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
        <a href="/tags/%E8%87%AA%E5%AE%9A%E4%B9%89/" itemprop="url" rel="tag"><span itemprop="name">自定义</span></a>
      </span>
  </span>


    <span class="post-meta-item" title="Symbols">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols: </span>
      <span>19k</span>
    </span>
    <span class="post-meta-item" title="Duration">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Duration &asymp;</span>
      <span>21 mins.</span>
    </span>
</div>

            <div class="post-description">（1）GitHub 多 Page 仓库部署（账号 Page 与项目 Page）；（2）云服务器部署（创建、配置、部署、SSL 证书）。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">




    <script>
        // 目前有一键回顶部和一键去底部按钮，暂时不启用文章的顶部导航：
        // insertHeaderNavigation();

        function insertHeaderNavigation() {
            const postHeaderDiv = document.querySelectorAll('.post-header')[0];
            if (postHeaderDiv == null) {
                return;
            }
            const isNavigationEnabled = "right";
            if (!isNavigationEnabled) {
                return;
            }

            // 不知道为什么，直接获取 post.next 会导致 post.njk 渲染失败，但是又能直接读属性。。。
            
            
            const isNextPostAtRight = ("right" === 'right');
            var leftPostTitle, leftPostPath, rightPostTitle, rightPostPath;
            if (isNextPostAtRight) {
                leftPostTitle = "Hexo-问题及方案";
                leftPostPath = "post/hexodiy/hexodiy-solutions/";
                rightPostTitle = "Hexo-自定义样式";
                rightPostPath = "post/hexodiy/hexodiy-style/";
            } else {
                leftPostTitle = "Hexo-自定义样式";
                leftPostPath = "post/hexodiy/hexodiy-style/";
                rightPostTitle = "Hexo-问题及方案";
                rightPostPath = "post/hexodiy/hexodiy-solutions/";
            }
            const leftPostRelatedUrl = "/" + leftPostPath;
            const rightPostRelatedUrl = "/" + rightPostPath;
            if ((leftPostPath == null || leftPostPath.length <= 0) && (rightPostPath == null || rightPostPath.length <= 0)) {
                return;
            }

            var headerNavDiv = document.createElement('div');
            headerNavDiv.className = 'post-nav';
            // 反转 style-border 样式：
            headerNavDiv.style.borderTop = "none";
            headerNavDiv.style.borderBottom = "1px solid #808080";
            // 反转 style-margin 样式：
            headerNavDiv.style.marginTop = "-20px";
            // headerNavDiv.style.marginBottom = "1em";
            headerNavDiv.style.marginBottom = "80px";
            // 反转 style-padding 样式：
            headerNavDiv.style.padding = "0 5px 10px";
            postHeaderDiv.insertBefore(headerNavDiv, postHeaderDiv.firstChild);

            if (leftPostPath != null && leftPostPath.length > 0) {
                var headerNavLeftDiv = document.createElement('div');
                headerNavLeftDiv.className = 'post-nav-item';
                headerNavDiv.append(headerNavLeftDiv);

                var headerNavLeftLink = document.createElement('a');
                headerNavLeftLink.title = leftPostTitle;
                headerNavLeftLink.href = leftPostRelatedUrl;
                headerNavLeftLink.rel = "prev";
                headerNavLeftLink.style.textAlign = "left";
                headerNavLeftDiv.append(headerNavLeftLink);

                var headerNavLeftIcon = document.createElement('i');
                headerNavLeftIcon.className = 'fa fa-angle-left';
                headerNavLeftLink.append(headerNavLeftIcon);

                var headerNavLeftTitleNode = document.createTextNode(leftPostTitle);
                headerNavLeftLink.append(headerNavLeftTitleNode);
            }
            if (rightPostPath != null && rightPostPath.length > 0) {
                var headerNavRightDiv = document.createElement('div');
                headerNavRightDiv.className = 'post-nav-item';
                headerNavDiv.append(headerNavRightDiv);

                var headerNavRightLink = document.createElement('a');
                headerNavRightLink.title = rightPostTitle;
                headerNavRightLink.href = rightPostRelatedUrl;
                headerNavRightLink.rel = "next";
                headerNavRightLink.style.textAlign = "right";
                headerNavRightDiv.append(headerNavRightLink);

                var headerNavRightTitleNode = document.createTextNode(rightPostTitle);
                headerNavRightLink.append(headerNavRightTitleNode);

                var headerNavRightIcon = document.createElement('i');
                headerNavRightIcon.className = 'fa fa-angle-right';
                headerNavRightLink.append(headerNavRightIcon);
            }
        }
    </script>
<span id="more"></span>

<h1 id="Hexo-自定义部署"><a href="#Hexo-自定义部署" class="headerlink" title="Hexo-自定义部署"></a>Hexo-自定义部署</h1><h2 id="1-多Page仓库部署"><a href="#1-多Page仓库部署" class="headerlink" title="1. 多Page仓库部署"></a>1. 多Page仓库部署</h2><p>在 <a href="/post/hexodiy/hexodiy-init/" title="@LINK">Hexo-初始化静态网站</a> 中提到，GitHub 允许一个账号拥有 1 个 <strong>账号 Page</strong> 和多个 <strong>项目 Page</strong>，因此可以利用多个项目 Page 达到分内容、分域名、冗余部署等。</p>
<blockquote>
<p>开启项目 Page 的前提是已经开启了账号 Page，确保可用默认域名 <code>[username].github.io</code> 访问账号 Page。</p>
</blockquote>
<h3 id="1-1-开启项目Page"><a href="#1-1-开启项目Page" class="headerlink" title="1.1 开启项目Page"></a>1.1 开启项目Page</h3><p>新建一个 GitHub 仓库用作项目 Page，GitHub 对项目 Page 的仓库名没有限制。</p>
<p>新建完成后需要初始化仓库以及提交一个初始 Commit，以一个简单的 HTML 源文件为例，在本地创建如下代码并上传到项目 Page 仓库的 <code>main</code> 分支中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>This is Project Page.<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>在项目 Page 仓库的 <code>Settings - Pages</code> 中的部署源选项 <code>Source</code> 选择 <code>main</code> 分支，则项目 Page 就已经建立好了，默认情况下这个项目 Page 的访问域名为：<code>[username].github.io/DemoPage</code>。</p>
<h3 id="1-2-自定义域名"><a href="#1-2-自定义域名" class="headerlink" title="1.2 自定义域名"></a>1.2 自定义域名</h3><p>GitHub Page 设置域名的方式是在 Page 仓库根目录下创建一个没有后缀的文件 <code>CNAME</code>，并在文件中写入一行（且只能有一行）需要自定义的域名，例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxx.com</span><br></pre></td></tr></table></figure>

<p>然后在 DNS 添加一条 CName记录，让 <code>xxx.com</code> 指向 <code>[username].github.io</code> 即可。需要注意的是，<code>CNAME</code> 文件中指定的是纯域名，不携带任何协议网络（例如 <code>http</code>、<code>https</code> 等）。</p>
<blockquote>
<p>假设账号 Page 设置了自定义域名 <code>xxx.com</code>、项目 Page 的仓库名为 <code>DemoPage</code>。</p>
</blockquote>
<p>默认情况下，项目 Page 的访问路径是作为账号 Page 的子路径访问的，则项目 Page 的访问路径会自动设置为 <code>xxx.com/DemoPage</code>。</p>
<p>如果想要用自定义域名访问，只需要在 DemoPage 仓库根目录下创建 <code>CNAME</code> 文件，并在其中写入对应的域名。</p>
<ul>
<li>作为子域名访问时，写入例如：<code>demo.xxx.com</code></li>
<li>作为独立的顶级域名访问时，写入例如：<code>yyy.com</code></li>
</ul>
<p>然后在对应域名的 DNS 中添加一条 CName 记录，同样指向账号 Page 的默认域名 <code>[username].github.io</code>，GitHub 会自动判断请求的域名是否指向了某个 Page，如果是则自动转发。</p>
<hr>
<h2 id="2-云服务器部署"><a href="#2-云服务器部署" class="headerlink" title="2. 云服务器部署"></a>2. 云服务器部署</h2><p>考虑到 GitHub Page 在国内访问不太稳定，受不同运营商、不同地域的影响差别很大，因此也希望能部署到云服务器上。</p>
<h3 id="2-1-搭建云服务器"><a href="#2-1-搭建云服务器" class="headerlink" title="2.1 搭建云服务器"></a>2.1 搭建云服务器</h3><p>云服务器按照个人需求选择即可。</p>
<blockquote>
<p>以腾讯云轻量应用服务器 + Ubuntu Server 18 LTS 为例。</p>
</blockquote>
<h4 id="2-1-1-准备部署环境"><a href="#2-1-1-准备部署环境" class="headerlink" title="2.1.1 准备部署环境"></a>2.1.1 准备部署环境</h4><ul>
<li>确保服务器已经可用，且具有公网 IP，允许公网访问。</li>
<li>确保本地已有可用 SSH 密钥。</li>
<li>服务器绑定 SSH 公钥，用于远端部署。</li>
</ul>
<h4 id="2-1-2-配置Ubuntu默认账号"><a href="#2-1-2-配置Ubuntu默认账号" class="headerlink" title="2.1.2 配置Ubuntu默认账号"></a>2.1.2 配置Ubuntu默认账号</h4><p>腾讯云轻量应用服务器的默认账号为 <code>ubuntu</code>，如果创建服务器实例时已经设置了该账号的密码则可以跳过。否则需要通过「重置密码」设置，注意设置时选择用户名 <code>系统默认 ubuntu</code>。</p>
<h4 id="2-1-3-登录服务器"><a href="#2-1-3-登录服务器" class="headerlink" title="2.1.3 登录服务器"></a>2.1.3 登录服务器</h4><p>腾讯云轻量应用服务器在选择 Ubuntu 镜像时，默认会创建一个用户 <code>lighthouse</code>，并且腾讯云默认禁用了 root 用户，尽管可以通过配置开启，但远端登录时仍有许多问题。因此建议切换为标准的默认用户 <code>ubuntu</code>，否则后续需要多次调整权限。</p>
<p>网页端控制台可以在登录后通过 <code>su ubuntu</code> 切换至 <code>ubuntu</code> 账号，远端登录时可以通过 SSH 连接直接指定登录用户：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// [username] 即为需要登录的用户，前提是该用户已创建。</span><br><span class="line">// [server ip] 即为服务器的公网 IP，如果没有则需要购买公网 IP。</span><br><span class="line">ssh [username]@[server ip]</span><br></pre></td></tr></table></figure>

<p>（1）如果首次从本地远端登录，可能会提示密钥交换信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">The authenticity of host &#x27;XXX.XXX.XXX.XXX (XXX.XXX.XXX.XXX)&#x27; can&#x27;t be established.</span><br><span class="line">RSA key fingerprint is XXXXXXXXXXXXXXXXXXXXXXXXXXXXX.</span><br><span class="line">Are you sure you want to continue connecting (yes/no/fingerprint)?</span><br></pre></td></tr></table></figure>

<p>输入 <code>yes</code> 继续即可。</p>
<p>（2）如果曾经连接过，但是服务器重置了或者公网 IP 有变更，则远端登录时可能提示错误：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class="line">@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @</span><br><span class="line">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class="line">IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!</span><br><span class="line">Someone could be eavesdropping on you right now (man-in-the-middle attack)!</span><br><span class="line">It is also possible that a host key has just been changed.</span><br><span class="line">The fingerprint for the RSA key sent by the remote host is</span><br><span class="line">SHA256:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX.</span><br><span class="line">Please contact your system administrator.</span><br><span class="line">Add correct host key in ~/.ssh/known_hosts to get rid of this message.</span><br><span class="line">Offending RSA key in ~/.ssh/known_hosts:4</span><br><span class="line">RSA host key for XXX.XXX.XXX.XXX has changed and you have requested strict checking.</span><br><span class="line">Host key verification failed.</span><br></pre></td></tr></table></figure>

<p>根据提示编辑 <code>~/.ssh/known_hosts</code> 文件，删除曾经保存的服务器 IP 对应的 Host 信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 删除公网 IP 对应的这条 Host 记录并保存</span><br><span class="line">XXX.XXX.XXX.XXX ecdsa-sha2-nistp256 XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><br></pre></td></tr></table></figure>

<p>然后再重新登录即可。</p>
<h3 id="2-2-配置云服务器"><a href="#2-2-配置云服务器" class="headerlink" title="2.2 配置云服务器"></a>2.2 配置云服务器</h3><p>配置云服务器有两种方式：</p>
<ol>
<li>使用默认 ubuntu 用户 + <code>sudo</code> 操作，但某些脚本可能需要单独设置 root 权限。</li>
<li>使用 root 用户配置，但远端使用 SSH 鉴权 Push 时也需要指定为 root 用户，可能会有安全性问题，不推荐。</li>
</ol>
<p>结合上述问题，本文以第 2 种方式为例，使用 root 用户配置服务器，但禁用远端登录 root 用户，配置完后再对远端 Push 涉及的目录设置为 ubuntu 用户权限。</p>
<h4 id="2-2-1-开启Root用户"><a href="#2-2-1-开启Root用户" class="headerlink" title="2.2.1 开启Root用户"></a>2.2.1 开启Root用户</h4><p>腾讯云轻量应用服务器默认禁用了 root 用户，需要先以普通用户（例如 ubuntu）登录后再手动开启：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// 1. 设置 root 用户密码，可以与其他用户的相同：</span><br><span class="line"><span class="meta">ubuntu@~$</span><span class="bash"> sudo passwd root</span></span><br><span class="line">// 二次输入密码后提示设置成功：</span><br><span class="line">passwd: password updated successfully</span><br><span class="line"></span><br><span class="line">// 2. 编辑配置文件 Authentication 部分，开启 root 密码登录：</span><br><span class="line"><span class="meta">ubuntu@~$</span><span class="bash"> sudo vi /etc/ssh/sshd_config</span></span><br><span class="line"></span><br><span class="line">// 2.1 取消 PermitRootLogin 选项的注释，</span><br><span class="line">// 默认配置 prohibit-password，禁止 Root 用户使用密码登录：</span><br><span class="line">PermitRootLogin prohibit-password</span><br><span class="line"></span><br><span class="line">// 2.2 如果需要允许 Root 用户登录，则修改 PermitRootLogin：</span><br><span class="line">PermitRootLogin yes</span><br><span class="line">// 然后添加一条配置，允许使用密码认证：</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line"></span><br><span class="line">// 3. 保存配置退出编辑模式后，重启 SSH 服务</span><br><span class="line"><span class="meta">ubuntu@~$</span><span class="bash"> sudo service ssh restart</span></span><br></pre></td></tr></table></figure>

<p>断开远端连接重新登录；如果允许直接通过密码远端登录 root 用户，则可以直接通过 <code>ssh root@[server ip]</code> 登录。本文为了安全性保持禁用 root 用户直接密码登录，因此仍需先以 ubuntu 用户登录，然后再切换至 root 用户：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 从本地登录至远端 ubuntu 用户：</span><br><span class="line"><span class="meta">[luis@~]#</span><span class="bash"> ssh ubuntu@XXX.XXX.XXX.XXX</span></span><br><span class="line"></span><br><span class="line">// 登录后切换至 root 用户，输入 root 密码：</span><br><span class="line"><span class="meta">ubuntu@~$</span><span class="bash"> su root</span></span><br><span class="line"></span><br><span class="line">// 切换成功后可以看到已经切换至 root 用户，且命令进入特权模式：</span><br><span class="line"><span class="meta">root@/home/ubuntu#</span></span><br></pre></td></tr></table></figure>

<h4 id="2-2-2-安装环境"><a href="#2-2-2-安装环境" class="headerlink" title="2.2.2 安装环境"></a>2.2.2 安装环境</h4><p>在云服务器部署静态网站，主要需要用到两个开发环境：</p>
<ul>
<li>Nginx: 用于自动把公网请求映射到具体的静态网页资源。</li>
<li>Git: 用于从本地推送静态网站资源。</li>
</ul>
<p>腾讯云轻量应用服务器的 Ubuntu 系统默认自带了 Git 环境，因此只需要安装 Nginx：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 更新 apt：</span><br><span class="line"><span class="meta">root@/home/ubuntu#</span><span class="bash"> apt-get update</span></span><br><span class="line">// 安装 nginx：</span><br><span class="line"><span class="meta">root@/home/ubuntu#</span><span class="bash"> apt-get install git nginx -y</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Nginx 常用命令：</p>
<ul>
<li>启动服务：<code>service nginx start</code></li>
<li>停止服务：<code>service nginx stop</code></li>
<li>重启服务：<code>service nginx restart</code></li>
<li>刷新配置：<code>nginx -s reload</code>（需要先启动 Nginx 服务）</li>
</ul>
<p>注意：启动服务并不会自动读取最新配置，每次修改 Nginx 配置后都需要刷新配置才能生效。</p>
</blockquote>
<h4 id="2-2-3-配置网站目录"><a href="#2-2-3-配置网站目录" class="headerlink" title="2.2.3 配置网站目录"></a>2.2.3 配置网站目录</h4><p>采用 Nginx + Git 托管静态网站需要用到两个目录：</p>
<ul>
<li>Nginx 最终代理和转发的网站资源文件目录。</li>
<li>Git 接收远端 Push 网站资源文件的 Git 仓库目录。通过配置 Git Hook 将收到的文件自动关联到 Ngnix 的资源文件目录。</li>
</ul>
<p>（1）创建 Nginx 网站资源目录并授权；</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 实际目录可自定义：</span></span><br><span class="line"><span class="meta">ubuntu$</span><span class="bash"> sudo mkdir -p /xxx/WebServer</span></span><br><span class="line"><span class="meta">ubuntu$</span><span class="bash"> sudo chmod -R 755 /xxx/WebServer</span></span><br></pre></td></tr></table></figure>

<p>（2）创建 Git 接收裸仓库的目录并授权；</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 注意创建的是裸仓库，添加 --bare 参数</span></span><br><span class="line"><span class="meta">ubuntu$</span><span class="bash"> sudo git init --bare /xxx/Web.git</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 提示创建成功</span></span><br><span class="line">Initialized empty Git repository in /xxx/Web.git/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">ubuntu$</span><span class="bash"> sudo chmod -R 755 /xxx/Web.git</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Git 裸仓库是指该仓库将只保存仓库的提交历史（<code>.git</code> 文件），而不会保存实际文件，但同样支持 Push 和 Pull，通常作为服务器存储仓库。</p>
</blockquote>
<p>（3）配置 Nginx 代理和转发目录（注意备份）；</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">ubuntu$</span><span class="bash"> sudo vim /etc/nginx/sites-available/default</span></span><br></pre></td></tr></table></figure>

<p>修改 server 部分</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        # 监听普通 HTTP 的 80 端口：</span><br><span class="line">        listen 80 default_server;</span><br><span class="line">        listen [::]:80 default_server;</span><br><span class="line"></span><br><span class="line">        # SSL configuration（监听 HTTPS 的 443 端口）：</span><br><span class="line">        listen 443 ssl default_server;</span><br><span class="line">        listen [::]:443 ssl default_server;</span><br><span class="line"></span><br><span class="line">        # 设置代理和转发的目录：</span><br><span class="line">        root /xxx/WebServer;</span><br><span class="line"></span><br><span class="line">        # 指定监听的域名：</span><br><span class="line">        server_name example.com;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后重启 Nginx 服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">ubuntu$</span><span class="bash"> sudo service nginx restart</span></span><br></pre></td></tr></table></figure>

<h4 id="2-2-4-验证网站访问性"><a href="#2-2-4-验证网站访问性" class="headerlink" title="2.2.4 验证网站访问性"></a>2.2.4 验证网站访问性</h4><p>（1）在 <code>WebServer</code> 目录下创建一个测试网页：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">ubuntu$</span><span class="bash"> vim /xxx/WebServer/index.html</span></span><br></pre></td></tr></table></figure>

<p>随便填充一个元素：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>This is My Web.<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后访问公网 IP，如果可以正常访问说明配置正确；如果网页报 404 错误，则需要查看 Nginx 错误日志。</p>
<p>（2）Nginx 日志存放目录配置在 Nginx 配置文件中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">ubuntu$</span><span class="bash"> sudo vim /etc/nginx/nginx.conf</span></span><br></pre></td></tr></table></figure>

<p>找到 http 部分的 Logging 设置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">        access_log /var/log/nginx/access.log;</span><br><span class="line">        error_log /var/log/nginx/error.log;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后查看错误日志：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">ubuntu$</span><span class="bash"> sudo vim /var/<span class="built_in">log</span>/nginx/error.log</span></span><br><span class="line"></span><br><span class="line">yyyy/MM/dd hh:mm:ss [crit] 18205#18205: *1 stat() &quot;/xxx/WebServer/&quot; failed (13: Permission denied), client: XXX.XXX.XXX.XXX, server: example.com, request: &quot;GET / HTTP/1.1&quot;, host: &quot;XXX.XXX.XXX.XXX&quot;</span><br></pre></td></tr></table></figure>

<p>错误日志提示发生了 403 权限拒绝问题。</p>
<p>（3）查看 Nginx 的运行和启动用户：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">ubuntu$</span><span class="bash"> sudo ps aux | grep <span class="string">&quot;nginx: worker process&quot;</span> | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span></span></span><br><span class="line"></span><br><span class="line">www-data</span><br><span class="line">root</span><br></pre></td></tr></table></figure>

<p>发现 Nginx 启动用户是 root，但运行用户是 www-data，所以出现了用户权限被拒绝的情况。</p>
<p>（4）将 Nginx 的运行用户也修改为 root 用户：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">ubuntu$</span><span class="bash"> sudo vim /etc/nginx/nginx.conf</span></span><br></pre></td></tr></table></figure>

<p>将 user 修改为 root 用户：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user root;</span><br></pre></td></tr></table></figure>

<p>然后重启 Nginx 服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">ubuntu$</span><span class="bash"> sudo service nginx restart</span></span><br></pre></td></tr></table></figure>

<p>再次访问云服务器的公网 IP，可以正确访问了。</p>
<h4 id="2-2-5-创建Git-Hook"><a href="#2-2-5-创建Git-Hook" class="headerlink" title="2.2.5 创建Git-Hook"></a>2.2.5 创建Git-Hook</h4><p>由于 Nginx 只能将网络请求代理和转发到 <code>WebServer</code> 目录下的网站资源文件，而本地的网站资源文件是通过 Git Push 到 <code>Web.git</code> 仓库下的，因此需要创建一个 Git-Hook，自动将 <code>Web.git</code> 下的资源文件关联到 <code>WebServer</code> 目录中：</p>
<p>（1）创建一个 Hook 文件 <code>post-receive</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">ubuntu$</span><span class="bash"> vim /xxx/Web.git/hooks/post-receive</span></span><br></pre></td></tr></table></figure>

<p>（2）在 <code>post-receive</code> 中写入一行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git --work-tree=/xxx/WebServer --git-dir=/xxx/Web.git checkout -f</span><br></pre></td></tr></table></figure>

<p>（3）保存退出后，给 <code>post-receive</code> 文件添加执行权限：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">ubuntu$</span><span class="bash"> chmod +x /xxx/Web.git/hooks/post-receive</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-本地Push至云服务器"><a href="#2-3-本地Push至云服务器" class="headerlink" title="2.3 本地Push至云服务器"></a>2.3 本地Push至云服务器</h3><p>经过上述配置，服务器中的 Git 接收和 Nginx 代理转发已经配置好了，即可从本地将 Hexo 生成的静态网站 Push 至服务器。</p>
<p>（1）在 Hexo 站点配置文件中添加云服务器 Git 部署配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="comment">## 部署至 GitHub Page 仓库：</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">git@github.com:[username]/[username].github.io.git</span></span><br><span class="line">    <span class="attr">branch:</span> <span class="string">main</span></span><br><span class="line">  <span class="comment">## 部署至云服务器：</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">ubuntu@[server</span> <span class="string">ip]:/xxx/Web.git</span></span><br></pre></td></tr></table></figure>

<p>（2）本地执行 Hexo 命令部署：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">luis$</span><span class="bash"> hexo clean &amp;&amp; hexo g -d</span></span><br></pre></td></tr></table></figure>

<p>有可能报错 <code>unable to create temporary object directory</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">error: remote unpack failed: unable to create temporary object directory</span><br><span class="line">error: failed to push some refs to &#x27;ubuntu@43.129.198.91:/xxx/Web.git&#x27;</span><br></pre></td></tr></table></figure>

<p>也有可能报错 <code>Permission denied</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error: unable to create file xxx: Permission denied</span><br></pre></td></tr></table></figure>

<p>向云服务器 Push 时报错，如果原因为 <code>unable to create</code>、<code>unable to access</code>、<code>permission denied</code> 等，绝大多数是因为 Git Push 的用户没有目标路径的权限导致的，在本例中，<code>WebServer</code> 或 <code>Web.git</code> 所在目录、以及其内所有子文件都是 root 用户权限，而云服务器为了安全禁用了远端登录 root 用户，所以 Git 在以 ubuntu 用户 Push 时就会导致权限不足。</p>
<p>（3）将云服务器中 <code>WebServer</code> 和 <code>Web.git</code> 所在目录、以及内部递归所有子文件都改为 ubuntu 用户权限：</p>
<blockquote>
<p>需要修改 WebServer、Web.git、以及各自所在的所有父级目录。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 递归修改该目录及其内部所有子文件的权限，</span></span><br><span class="line"><span class="meta">ubuntu$</span><span class="bash"> sudo chown -R <span class="variable">$USER</span>:<span class="variable">$USER</span> /xxx/xxx</span></span><br></pre></td></tr></table></figure>

<p>（4）再次查看文件权限，确保上述各个目录均可被 ubuntu 用户访问：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">ubuntu$</span><span class="bash"> ll</span></span><br><span class="line"></span><br><span class="line">drwxr-xr-x 4 ubuntu ubuntu 4096 Aug  1 hh:mm /xxx/xxx</span><br></pre></td></tr></table></figure>

<p>（5）再次从本地执行 Hexo 命令，即可成功部署。</p>
<h3 id="2-4-GitHub-Page开启HTTPS"><a href="#2-4-GitHub-Page开启HTTPS" class="headerlink" title="2.4 GitHub-Page开启HTTPS"></a>2.4 GitHub-Page开启HTTPS</h3><p>GitHub Page 只需要确保域名已绑定 SSL 证书，然后在 Page 仓库的 <code>Settings - Pages</code> 中勾选 <code>Enforce HTTPS</code> 即可。</p>
<h3 id="2-5-云服务器开启HTTPS"><a href="#2-5-云服务器开启HTTPS" class="headerlink" title="2.5 云服务器开启HTTPS"></a>2.5 云服务器开启HTTPS</h3><p>云服务器开启 HTTPS 需要自行申请 SSL 证书：</p>
<ul>
<li>使用域名提供商颁发的证书：<ul>
<li>通常有免费证书（一般有效期最大 90 天），不支持原证书续签，每次都要重新申请后手动替换证书公私钥；</li>
<li>购买付费证书；</li>
</ul>
</li>
<li>使用 LetsEncrypt 颁发的免费证书（有效期 90 天），可以直接在服务器使用脚本配置：<ul>
<li>由于地区限制，<code>.cn</code> 顶域只能通过 DNS 的方式验证，因此域名过期后只能重新申请证书并手动更新 DNS 验证，但无需替换公私钥文件（Certbot 会用新证书覆盖）；</li>
<li>其他国际域名可通过 HTTP + WebRoot 的方式自动验证域名，可以配合 <code>crontab</code> 实现自动续签；</li>
</ul>
</li>
</ul>
<p>注意：</p>
<ul>
<li>根域名（顶级域名，如 <code>example.com</code>）和 子域名/泛域名（如 <code>xxx.example.com</code>）需要分别申请各自的证书。</li>
<li>使用 LetsEncrypt 颁发的证书时，如果服务器在大陆境内则需要先为服务器备案。</li>
<li>Nginx 配置 SSL 需要证书的公钥和私钥。</li>
</ul>
<h4 id="2-5-1-从域名提供商获取SSL证书"><a href="#2-5-1-从域名提供商获取SSL证书" class="headerlink" title="2.5.1 从域名提供商获取SSL证书"></a>2.5.1 从域名提供商获取SSL证书</h4><p>如果使用域名提供商的证书（不论 免费/付费），优先选择标明了 Nginx 场景的证书，或者下载包含 <code>pem 文件</code>、<code>crt 文件</code>、<code>key 文件</code> 的证书：</p>
<ul>
<li>公钥：<code>domain.crt</code> 或 <code>domain.pem</code> 文件；</li>
<li>私钥：<code>domain.key</code> 文件；</li>
</ul>
<p>然后将证书从本地上传到远端：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在本地终端执行以下代码：</span></span><br><span class="line">scp ./domain.crt ubuntu@xx.xx.xx.xx:/xxx/domain.crt</span><br><span class="line">scp ./domain.key ubuntu@xx.xx.xx.xx:/xxx/domain.key</span><br></pre></td></tr></table></figure>

<p>注意，这一步命令可能会遇到报错 <code>Permission denied (publickey)</code>，则检查以下配置：</p>
<ul>
<li><p>检查目标路径的用户权限，例如服务器当前用户是 ubuntu，但 <code>/DemoDir</code> 这个目录可能是 root 用户权限，解决办法为：</p>
<ul>
<li>scp 命令改为指定 root 用户登录服务器，但通常服务器为了安全会禁用 root 用户的远端登录，因此不推荐。</li>
<li>scp 目标路径临时选择一个 ubuntu 用户有权限的目录，然后登录到服务器后再移动到其他目录，此时可以自由切换 root 用户了。</li>
</ul>
</li>
<li><p>检查服务器用户的 SSH 配置中是否绑定了本地公钥：</p>
<ul>
<li>查看服务器的 <code>~/.ssh/authorized_keys</code> 文件，是否包含本地 <code>~/.ssh/id_rsa.pub</code> 公钥内容。</li>
<li>如果没有，则将本地 <code>id_rsa.pub</code> 公钥内容追加到服务器 <code>authorized_keys</code> 文件后（该文件可以包含多个公钥的内容）。</li>
</ul>
</li>
</ul>
<h4 id="2-5-2-LetsEncrypt证书-DNS校验"><a href="#2-5-2-LetsEncrypt证书-DNS校验" class="headerlink" title="2.5.2 LetsEncrypt证书+DNS校验"></a>2.5.2 LetsEncrypt证书+DNS校验</h4><p>使用 LetsEncrypt 颁发的证书本质也是在服务器内下载证书，不过 LetsEncrypt 提供了 <code>certbot</code> 脚本，可以在服务器内完成：</p>
<p>（1）安装 Certbot：</p>
<blockquote>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Vanilla-chan/p/18900827">在Ubuntu上使用Let&#39;s Encrypt配置Nginx SSL证书并自动更新</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/7522006762511613971">在Ubuntu上使用Certbot申请Let’s Encrypt SSL证书</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/KLangHu/p/17723048.html">Ubuntu通过certbot手动配置Let&#39;s Encrypt SSL泛型域名证书</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.arisa.moe/blog/2022/220407-certbot/">certbot 常用操作</a></li>
</ul>
<p>Ubuntu 下默认没有 yum 源：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.51cto.com/u_13968834/13252792">使用yum提示&quot;There are no enabled repos&quot;</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2089090">Ubuntu下安装yum和配置yum源</a></li>
</ul>
<p>Apache 服务器可以参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/MonkeyBananas/article/details/149022366">ubuntu系统申请免费HTTPS证书</a></li>
</ul>
<p>其他 OS 可以使用 yum 安装，参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Unstoppable9527/p/18709231">CertBot自动更新Nginx证书</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/nickchou/p/12679518.html">centos 7 nginx 配置Let&#39;s Encrypt证书，并自动更新</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/pyt666/p/18110240">使用CertBot自动更新Nginx的ssl证书</a></li>
<li><a target="_blank" rel="noopener" href="https://www.xgss.net/6961.html">Linux 下 Nginx 安装部署 Let’s Encrypt 证书实现 HTTPS</a></li>
</ul>
<p>使用 Docker 可以参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/LQ137969328/article/details/148745200">生成https免费证书并绑定到nginx</a></li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install certbot</span><br></pre></td></tr></table></figure>

<p>（2）为根域名 <code>example.com</code> 和 泛域名 <code>*.example.com</code> 同时申请证书：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo certbot certonly -d example.com -d *.example.com --manual --preferred-challenges dns</span><br></pre></td></tr></table></figure>

<p>LetsEncrypt 会询问是否接受服务器 IP 被记录，必须接受才能继续申请：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Saving debug log to /var/log/letsencrypt/letsencrypt.log</span><br><span class="line">Plugins selected: Authenticator manual, Installer None</span><br><span class="line">Obtaining a new certificate</span><br><span class="line">Performing the following challenges:</span><br><span class="line">dns-01 challenge for example.com</span><br><span class="line">dns-01 challenge for example.com</span><br><span class="line"></span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">NOTE: The IP of this machine will be publicly logged as having requested this</span><br><span class="line">certificate. If you&#x27;re running certbot in manual mode on a machine that is not</span><br><span class="line">your server, please ensure you&#x27;re okay with that.</span><br><span class="line"></span><br><span class="line">Are you OK with your IP being logged?</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">(Y)es/(N)o:</span><br></pre></td></tr></table></figure>

<p>输入 <code>Y</code> 后 LetsEncrypt 会分别为根域名和泛域名生成 DNS 的 TXT 记录用于校验，需要手动将其添加到域名 DNS 解析中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(Y)es/(N)o: Y</span><br><span class="line"></span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">Please deploy a DNS TXT record under the name</span><br><span class="line">_acme-challenge.example.com with the following value:</span><br><span class="line"></span><br><span class="line">******************************************</span><br><span class="line"></span><br><span class="line">Before continuing, verify the record is deployed.</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">Press Enter to Continue</span><br><span class="line"></span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">Please deploy a DNS TXT record under the name</span><br><span class="line">_acme-challenge.example.com with the following value:</span><br><span class="line"></span><br><span class="line">******************************************</span><br><span class="line"></span><br><span class="line">Before continuing, verify the record is deployed.</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">Press Enter to Continue</span><br></pre></td></tr></table></figure>

<p>（3）在下一步之前，确保已经在 DNS 解析中为根域名和泛域名分别添加了一条 TXT 记录</p>
<p>（4）输入回车继续，LetsEncrypt 会通过 DNS 校验域名的合法性，稍等片刻校验通过后将会自动下载证书到本地：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Waiting for verification...</span><br><span class="line">Cleaning up challenges</span><br><span class="line"></span><br><span class="line">IMPORTANT NOTES:</span><br><span class="line"> - Congratulations! Your certificate and chain have been saved at:</span><br><span class="line">   /etc/letsencrypt/live/example.com/fullchain.pem</span><br><span class="line">   Your key file has been saved at:</span><br><span class="line">   /etc/letsencrypt/live/example.com/privkey.pem</span><br><span class="line">   Your cert will expire on YYYY-MM-DD. To obtain a new or tweaked</span><br><span class="line">   version of this certificate in the future, simply run certbot</span><br><span class="line">   again. To non-interactively renew *all* of your certificates, run</span><br><span class="line">   &quot;certbot renew&quot;</span><br><span class="line"> - If you like Certbot, please consider supporting our work by:</span><br><span class="line"></span><br><span class="line">   Donating to ISRG / Let&#x27;s Encrypt:   https://letsencrypt.org/donate</span><br><span class="line">   Donating to EFF:                    https://eff.org/donate-le</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li><code>/etc/letsencrypt/live/example.com/fullchain.pem</code> 为公钥</li>
<li><code>/etc/letsencrypt/live/example.com/privkey.pem</code> 为私钥</li>
</ul>
<p>（5）使用 DNS 校验的证书续签时需要重新执行一遍申请流程，但由于证书文件路径不变（新证书将覆盖旧证书），只需要重新使用 Certbot 生成新的校验 Key 并更新到 DNS 即可。</p>
<blockquote>
<p>国内域名只能使用 DNS 校验，其他校验方式会报错（参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_34200628/article/details/88118312">Let&#39;s encrypt的TLS-SNI安全问题</a>）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Client with the currently selected authenticator does not support any combination of challenges that will satisfy the CA. You may need to use an authenticator plugin that can do challenges over DNS.</span><br></pre></td></tr></table></figure>

<p>但 Github 上有不少工具可以通过 DNS 服务商提供的 API 接口实现续签时自动化更新 DNS 记录，例如腾讯云：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_53071854/article/details/147784021">Certbot+Letsencrypt+腾讯云DNS验证自动续期证书</a></li>
<li><a target="_blank" rel="noopener" href="https://gitee.com/hillmans_admin/certbot-wildcard-qcloud-hook">hellomeet/certbot-wildcard-qcloud-hook</a></li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/3304123301">使用Certbot获取Let&#39;s Encrypt的SSL证书</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Leon_Jinhai_Sun/article/details/147659466">Let‘s Encrypt 域名验证的 Nginx 设置</a></li>
</ul>
</blockquote>
<p>查看所有 <code>certbot</code> 申请的证书的有效期：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo certbot certificates</span><br></pre></td></tr></table></figure>

<h4 id="2-5-3-LetsEncrypt证书-HTTP校验"><a href="#2-5-3-LetsEncrypt证书-HTTP校验" class="headerlink" title="2.5.3 LetsEncrypt证书+HTTP校验"></a>2.5.3 LetsEncrypt证书+HTTP校验</h4><p>（1）指定验证方式为 http：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">ubuntu$</span><span class="bash"> sudo certbot certonly --preferred-challenges http -d example.com</span></span><br></pre></td></tr></table></figure>

<p>（2）三种方式任选一项即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Saving debug log to /var/log/letsencrypt/letsencrypt.log</span><br><span class="line"></span><br><span class="line">How would you like to authenticate with the ACME CA?</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">1: Nginx Web Server plugin - Alpha (nginx)</span><br><span class="line">2: Spin up a temporary webserver (standalone)</span><br><span class="line">3: Place files in webroot directory (webroot)</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">Select the appropriate number [1-3] then [enter] (press &#x27;c&#x27; to cancel):</span><br></pre></td></tr></table></figure>

<p>（3）其中，方式 1（nginx）和方式 2（standalone）均为全自动完成，而方式 3（webroot）则需要指定一个目录；在证书续期（renew）时，LetsEncrypt 会在该目录下存放一个临时文件，并告知服务器通过访问域名的一个特定路径来验证是否可以读取到临时文件，因此这种方式还需要配置 Nginx，确保 LetsEncrypt 通过 HTTP 请求验证域名时可以被正确路由到该目录。</p>
<p>（4）以方式 3（WebRoot）为例，按要求指定 WebRoot 的路径：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Plugins selected: Authenticator webroot, Installer None</span><br><span class="line">Obtaining a new certificate</span><br><span class="line">Performing the following challenges:</span><br><span class="line">http-01 challenge for example.com</span><br><span class="line">Input the webroot for example.com: (Enter &#x27;c&#x27; to cancel): /xxx/webroot</span><br><span class="line">Waiting for verification...</span><br><span class="line">Cleaning up challenges</span><br><span class="line"></span><br><span class="line">IMPORTANT NOTES:</span><br><span class="line"> - Congratulations! Your certificate and chain have been saved at:</span><br><span class="line">   /etc/letsencrypt/live/example.com/fullchain.pem</span><br><span class="line">   Your key file has been saved at:</span><br><span class="line">   /etc/letsencrypt/live/example.com/privkey.pem</span><br><span class="line">   Your cert will expire on 2025-xx-xx. To obtain a new or tweaked</span><br><span class="line">   version of this certificate in the future, simply run certbot</span><br><span class="line">   again. To non-interactively renew *all* of your certificates, run</span><br><span class="line">   &quot;certbot renew&quot;</span><br><span class="line"> - If you like Certbot, please consider supporting our work by:</span><br><span class="line"></span><br><span class="line">   Donating to ISRG / Let&#x27;s Encrypt:   https://letsencrypt.org/donate</span><br><span class="line">   Donating to EFF:                    https://eff.org/donate-le</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li><code>/etc/letsencrypt/live/example.com/fullchain.pem</code> 为公钥</li>
<li><code>/etc/letsencrypt/live/example.com/privkey.pem</code> 为私钥</li>
</ul>
<p>（5）使用 <code>certbot</code> 手动更新证书</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 更新系统上所有 certbot 申请的证书：</span></span><br><span class="line">sudo certbot renew</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 模拟 certbot 更新证书（但不会实际更新）：</span></span><br><span class="line">sudo certbot renew --dry-run</span><br></pre></td></tr></table></figure>

<p>如果 <code>renew</code> 命令没有报错，就可以使用 <code>crontab</code> 周期性执行 <code>renew</code> 进行自动续签了。</p>
<p>（6）使用 <code>crontab</code> 定期自动更新证书</p>
<p>查看已配置的定期任务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cat /etc/crontab</span><br></pre></td></tr></table></figure>

<p>配置定期任务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">ubuntu$</span><span class="bash"> sudo crontab -e</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 根据提示选择习惯的编辑器：</span></span></span><br><span class="line">Select an editor.  To change later, run &#x27;select-editor&#x27;.</span><br><span class="line">  1. /bin/nano        &lt;---- easiest</span><br><span class="line">  2. /usr/bin/vim.basic</span><br><span class="line">  3. /usr/bin/vim.tiny</span><br><span class="line">  4. /bin/ed</span><br><span class="line"></span><br><span class="line">Choose 1-4 [1]: 2</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># crontab 通过 6 个选项配置定期任务，其中各项的含义如下（使用 * 表示任意满足）：</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Minute(0~59)  Hour(0~23)  DayOfMonth(1~31)  Month(1~12)  DayOfWeek(0~6)  Command</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># crontab 的默认配置内容如下，</span></span></span><br><span class="line">*/5 * * * * flock -xn /tmp/stargate.lock -c &#x27;/usr/local/qcloud/stargate/admin/start.sh &gt; /dev/null 2&gt;&amp;1 &amp;&#x27;</span><br></pre></td></tr></table></figure>

<p>在打开的编辑器中修改定期时间，并保存退出（以下配置表示每月 1 日执行 <code>certbot</code> 更新证书）：</p>
<blockquote>
<p>可以使用 <code>sudo certbot renew --dry-run</code> 测试证书更新流程是否能正确执行。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 1 * * /usr/bin/certbot renew --quiet</span><br></pre></td></tr></table></figure>

<h4 id="2-5-4-将SSL公私钥配置到Nginx"><a href="#2-5-4-将SSL公私钥配置到Nginx" class="headerlink" title="2.5.4 将SSL公私钥配置到Nginx"></a>2.5.4 将SSL公私钥配置到Nginx</h4><p>由于云服务器采用 Nginx 转发请求，因此需要将 SSL 证书的公私钥配置到 Nginx 中。</p>
<blockquote>
<p>如果使用 root 用户运行 Nginx，则需要切换至 root 用户再配置。</p>
</blockquote>
<p>（1）去除（注释掉）Nginx 默认 Server 配置 <code>/etc/nginx/sites-available/default</code>（注意备份）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        # listen 80 default_server;</span><br><span class="line">        # listen [::]:80 default_server;</span><br><span class="line">        # root /var/www/html;</span><br><span class="line">        # server_name _;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（2）修改 Nginx 转发配置 <code>/etc/nginx/nginx.conf</code>（注意备份），参考以下部分按实际情况修改：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">user root;</span><br><span class="line">worker_processes auto;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line">include /etc/nginx/modules-enabled/*.conf;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">        worker_connections 768;</span><br><span class="line">        # multi_accept on;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">        ## ---------- Basic Settings ---------- ##</span><br><span class="line"></span><br><span class="line">        sendfile on;</span><br><span class="line">        tcp_nopush on;</span><br><span class="line">        tcp_nodelay on;</span><br><span class="line">        keepalive_timeout 65;</span><br><span class="line">        types_hash_max_size 2048;</span><br><span class="line">        # server_tokens off;</span><br><span class="line"></span><br><span class="line">        # server_names_hash_bucket_size 64;</span><br><span class="line">        # server_name_in_redirect off;</span><br><span class="line"></span><br><span class="line">        include /etc/nginx/mime.types;</span><br><span class="line">        default_type application/octet-stream;</span><br><span class="line"></span><br><span class="line">        proxy_intercept_errors on;</span><br><span class="line"></span><br><span class="line">        ## ---------- Server Settings ---------- ##</span><br><span class="line"></span><br><span class="line">        # 禁止 IP 直接访问</span><br><span class="line">        server &#123;</span><br><span class="line">                server_name _;</span><br><span class="line">                listen 80 default_server;</span><br><span class="line">                listen [::]:80 default_server;</span><br><span class="line">                listen 443 ssl default_server;</span><br><span class="line">                listen [::]:443 ssl default_server;</span><br><span class="line">                return 444;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # 所有子域名转发至根域名（需要 DNS 解析）；</span><br><span class="line">        # 所有顶域（TLD）统一转发到 .com 顶域；</span><br><span class="line">        # HTTP 转发到 HTTPS。</span><br><span class="line">        #</span><br><span class="line">        # server_name 支持正则匹配泛域名，其中：</span><br><span class="line">        #   &#x27;~&#x27; 表示指定后面的内容为正则表达式，因此后面内容中的特殊符号需要反斜杠转义；</span><br><span class="line">        #   &#x27;^&#x27; 表示开始匹配的位置，即判断是否以该符号的下一个部分开头；</span><br><span class="line">        #   &#x27;$&#x27; 表示结束匹配的位置，即判断是否以该符号的前一个部分结尾；</span><br><span class="line">        #   &#x27;?&lt;name&gt;&#123;reg&#125;&#x27; 表示命名捕获，即获取满足 &#123;reg&#125; 条件的部分，并命名为 name；</span><br><span class="line">        #</span><br><span class="line">        # 以 ~^(?&lt;name1&gt;.+)\.example\.(?&lt;name2&gt;.+)$ 为例：</span><br><span class="line">        #   1. &#x27;~&#x27; 表示接下来的内容为正则表达式；</span><br><span class="line">        #   2. &#x27;^&#x27; 表示待匹配的内容需要以接下来的部分作为开头；</span><br><span class="line">        #   3. &#x27;?&lt;name1&gt;.+&#x27; 表示查找满足条件 .+ 的部分（且至少匹配一次）；</span><br><span class="line">        #   4. &#x27;$&#x27; 表示待匹配的内容需要以前一部分作为结尾；</span><br><span class="line">        # 若将规则用于匹配 sub.www.example.com 则：</span><br><span class="line">        #   1. name1 = sub.www</span><br><span class="line">        #   2. name2 = com</span><br><span class="line">        # 若将规则用于匹配 example.com 则：</span><br><span class="line">        #   匹配失败，因为 name1（对应 &#x27;.+&#x27;）表示必须至少匹配 1 次，也即不能为空。</span><br><span class="line">        #</span><br><span class="line">        # 可用变量：</span><br><span class="line">        #   $scheme     : &quot;http&quot; / &quot;https&quot; / ...</span><br><span class="line">        #   $host       : &quot;sub.example.com&quot;</span><br><span class="line">        #   $request_uri: &quot;/path/to/file?param=xxx&quot;</span><br><span class="line">        server &#123;</span><br><span class="line">                # 防止恶意域名指向服务器后 DDOS，仅匹配 .com 和 .cn 域名：</span><br><span class="line">                # server_name ~^(?&lt;subDomain&gt;.+)\.example\.(?&lt;domainTLD&gt;.+)$;</span><br><span class="line">                server_name ~^(?&lt;subDomain&gt;.*)\.?luisliu\.(com|cn)$;</span><br><span class="line">                listen 80;</span><br><span class="line">                listen [::]:80;</span><br><span class="line">                listen 443 ssl;</span><br><span class="line">                listen [::]:443 ssl;</span><br><span class="line">                return 301 https://example.com$request_uri;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # HTTP 自动转发至 HTTPS</span><br><span class="line">        # server &#123;</span><br><span class="line">        #         server_name example.com example.cn;</span><br><span class="line">        #         listen 80;</span><br><span class="line">        #         listen [::]:80;</span><br><span class="line">        #         return 301 https://$host$request_uri;</span><br><span class="line">        # &#125;</span><br><span class="line"></span><br><span class="line">        # 默认只代理 HTTPS 请求</span><br><span class="line">        server &#123;</span><br><span class="line">                server_name example.com example.cn;</span><br><span class="line">                listen 443 ssl;</span><br><span class="line">                listen [::]:443 ssl;</span><br><span class="line"></span><br><span class="line">                # 如果 LetsEncrypt 选择 Webroot 验证，则需要将 root 配置为同样的 WebRoot 目录：</span><br><span class="line">                location /.well-known/acme-challenge/ &#123;</span><br><span class="line">                        root /xxx/webroot;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                root /xxx/WebServer;</span><br><span class="line">                # autoindex on;</span><br><span class="line">                index index.html index.htm index.nginx-debian.html;</span><br><span class="line">                error_page 404 500 502 503 504 $scheme://$host/404;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ## ---------- SSL Settings ---------- ##</span><br><span class="line"></span><br><span class="line">        ssl_certificate /xxx/fullchain.pem;   # 对应前面获取的 SSL 证书的公钥</span><br><span class="line">        ssl_certificate_key /xxx/privkey.pem; # 对应前面获取的 SSL 证书的私钥</span><br><span class="line">        ssl_session_timeout 5m;</span><br><span class="line">        ssl_protocols TLSv1 TLSv1.1 TLSv1.2; # Dropping SSLv3, ref: POODLE</span><br><span class="line">        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;</span><br><span class="line">        ssl_prefer_server_ciphers on;</span><br><span class="line"></span><br><span class="line">        ## ---------- Logging Settings ---------- ##</span><br><span class="line"></span><br><span class="line">        access_log /var/log/nginx/access.log;</span><br><span class="line">        error_log /var/log/nginx/error.log;</span><br><span class="line"></span><br><span class="line">        ## ---------- Gzip Settings ---------- ##</span><br><span class="line"></span><br><span class="line">        gzip on;</span><br><span class="line"></span><br><span class="line">        # gzip_vary on;</span><br><span class="line">        # gzip_proxied any;</span><br><span class="line">        # gzip_comp_level 6;</span><br><span class="line">        # gzip_buffers 16 8k;</span><br><span class="line">        # gzip_http_version 1.1;</span><br><span class="line">        # gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;</span><br><span class="line"></span><br><span class="line">        ## ---------- Virtual Host Configs ---------- ##</span><br><span class="line"></span><br><span class="line">        include /etc/nginx/conf.d/*.conf;</span><br><span class="line">        include /etc/nginx/sites-enabled/*;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意以上 <code>ssl_certificate</code> 和 <code>ssl_certificate_key</code> 需要分别替换为之前获取到的 SSL 证书的公钥和私钥。</p>
<p>（3）验证 Nginx 配置并重启服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">ubuntu$</span><span class="bash"> sudo nginx -t</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果输出如下，说明配置正确，否则根据 [warn] 或 [error] 的提示修改。</span></span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试通过后，重启 Nginx 服务：</span></span><br><span class="line"><span class="meta">ubuntu$</span><span class="bash"> sudo nginx -s reload</span></span><br></pre></td></tr></table></figure>

<h3 id="2-6-验证网站访问"><a href="#2-6-验证网站访问" class="headerlink" title="2.6 验证网站访问"></a>2.6 验证网站访问</h3><ul>
<li>以 HTTP 协议访问云服务器公网 IP：报错 444.</li>
<li>以 HTTPS 协议访问云服务器公网 IP：报错 444。</li>
<li>以 HTTP 协议访问自定义域名：自动转发至 HTTPS。</li>
<li>以 HTTPS 协议访问自定义域名：正常访问。</li>
</ul>
<p>如果以上均验证成功，则网站已经正常部署。</p>
<h3 id="2-7-常见异常"><a href="#2-7-常见异常" class="headerlink" title="2.7 常见异常"></a>2.7 常见异常</h3><p>如果访问服务器时报错 403，先按上文所述查看 Nginx 的报错日志：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">ubuntu@~$</span><span class="bash"> vim /var/<span class="built_in">log</span>/nginx/error.log</span></span><br></pre></td></tr></table></figure>

<p>（1）<code>directory index of &quot;...&quot; is forbidden</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yyyy/MM/dd hh:mm:ss [error] 28043<span class="comment">#28043: *6 directory index of &quot;/home/ubuntu/Projects/WebServer/&quot; is forbidden, client: XXX.XXX.XXX.XXX, server: XXX.YYY, request: &quot;GET / HTTP/1.1&quot;, host: &quot;XXX.YYY&quot;</span></span><br></pre></td></tr></table></figure>

<p>首先检查 Git Push 是否成功，Hexo 在 Deploy 时，一旦某个文件 Push 失败则 Git 会中断 Push 任务，但只要 Push 任务结束 Hexo 就会提示 <code>INFO  Deploy done: git</code>，所以看到这个提示并不一定代表 Push 是成功的，需要检查 Deploy 日志，确保没有提示任何文件写入失败。如果有，大概率是权限问题导致的，可参照上文配置；如果没有，则需要检查 Nginx 配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">ubuntu@~$</span><span class="bash"> vim /etc/nginx/nginx.conf</span></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">        ## 默认只代理 HTTPS 请求</span><br><span class="line">        server &#123;</span><br><span class="line">                // 在默认代理 server 内添加该配置：</span><br><span class="line">                index index.html index.htm index.nginx-debian.html;</span><br><span class="line">                // 如果不确定网站使用的默认页，则添加如下配置：</span><br><span class="line">                autoindex on;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/120743882" title="@LINK">将hexo个人博客部署到个人云服务器--最详细踩坑教程</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/1207/47027" title="@LINK">Nginx 服务器证书安装</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">

          <div class="reward-container">
  <div> </div>
  <button>
    支持一下
  </button>
  <div class="post-reward">
      <div>
        <img src="/assets/images/reward.png" alt="LuisLiu WeChat Pay">
        <span>WeChat Pay</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>Post author:  </strong>LuisLiu
  </li>
  <li class="post-copyright-link">
      <strong>Post link: </strong>
      <a href="https://luisliu.cn/post/hexodiy/hexodiy-deploy/" title="Hexo-自定义部署">https://luisliu.cn/post/hexodiy/hexodiy-deploy/</a>
  </li>
  <li class="post-copyright-license">
      <strong>Copyright Notice:  </strong>All posts are written by Luis and licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a>, please get authorized before any references.
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Hexo/" rel="tag"><i class="fa fa-tag"></i> Hexo</a>
              <a href="/tags/%E8%87%AA%E5%AE%9A%E4%B9%89/" rel="tag"><i class="fa fa-tag"></i> 自定义</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/hexodiy/hexodiy-solutions/" rel="prev" title="Hexo-问题及方案">
                  <i class="fa fa-angle-left"></i> Hexo-问题及方案
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/hexodiy/hexodiy-style/" rel="next" title="Hexo-自定义样式">
                  Hexo-自定义样式 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
  <div class="languages">
    <label class="lang-select-label">
      <i class="fa fa-language"></i>
      <span>English</span>
      <i class="fa fa-angle-up" aria-hidden="true"></i>
    </label>
    <select class="lang-select" data-canonical="" aria-label="Select language">
      
        <option value="en" data-href="/post/hexodiy/hexodiy-deploy/" selected="">
          English
        </option>
      
        <option value="zh-CN" data-href="/zh-CN/post/hexodiy/hexodiy-deploy/" selected="">
          简体中文
        </option>
      
    </select>
  </div>

  <div class="copyright">
    &copy; 2018 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa-solid fa-at"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">LuisLiu</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>Symbols: </span>
    <span title="Symbols">526k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>Duration &asymp;</span>
    <span title="Duration">9:44</span>
  </span>
</div>


    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/liushulun" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>


  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>




<style type="text/css">
    .toBottom {
        color: #EEEEEE;
        border-bottom: none;
    }
    .toBottom:hover {
        color: #EB6D39;
        border-bottom: none;
    }
</style>





<div class="scrollToBottom back-to-top back-to-top-on" role="button" style="bottom: 61px;">
    <i class="fa fa-arrow-down fa-lg"></i>
    
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const scrollToBottom = document.querySelector('.scrollToBottom');
        /* 内联写法：
        $('.scrollToBottom').click(function(){
            $('html,body').animate({scrollTop:document.body.scrollHeight}, 500);
        });
        */
        scrollToBottom && scrollToBottom.addEventListener('click', () => {
            window.anime({
            targets  : document.scrollingElement,
            duration : 500,
            easing   : 'linear',
            scrollTop: document.scrollingElement.scrollHeight
            });
        });
    });
</script>

<a id='postBottom'></a>

</body>
</html>
